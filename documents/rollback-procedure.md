# Camera ZeroDay — Процедура отката

**Версия:** 1.0.0  
**Дата:** 2 декабря 2025

---

## Содержание

1. [Обзор](#1-обзор)
2. [Версионирование](#2-версионирование)
3. [Откат на Replit](#3-откат-на-replit)
4. [Откат на Render.com](#4-откат-на-rendercom)
5. [Откат Service Worker](#5-откат-service-worker)
6. [Откат IndexedDB](#6-откат-indexeddb)
7. [Чеклист после отката](#7-чеклист-после-отката)

---

## 1. Обзор

Camera ZeroDay использует систему версионирования для отслеживания изменений:

| Компонент | Расположение версии |
|-----------|---------------------|
| Приложение | `package.json` → `version` |
| PWA Manifest | `manifest.json` → `version` |
| Service Worker | `sw.js` → `CACHE_VERSION` |

**Важно:** Все три версии должны быть синхронизированы при релизе.

---

## 2. Версионирование

### Схема версий

Используется Semantic Versioning (SemVer): `MAJOR.MINOR.PATCH`

| Изменение | Пример | Описание |
|-----------|--------|----------|
| MAJOR | 1.0.0 → 2.0.0 | Breaking changes, несовместимые изменения |
| MINOR | 1.0.0 → 1.1.0 | Новые функции, обратная совместимость |
| PATCH | 1.0.0 → 1.0.1 | Баг-фиксы, мелкие исправления |

### Файлы для обновления при релизе

1. `package.json` — поле `version`
2. `client/public/manifest.json` — поле `version`
3. `client/public/sw.js` — константа `CACHE_VERSION`

---

## 3. Откат на Replit

### Использование Checkpoints

Replit автоматически создаёт checkpoints при работе.

**Шаги:**

1. Открыть Replit проект
2. Нажать кнопку **"View Checkpoints"** в интерфейсе
3. Выбрать нужный checkpoint по дате/времени
4. Нажать **"Restore"**

**Восстанавливается:**
- Код и файлы
- Состояние чата с агентом
- База данных (если используется Replit DB)

**НЕ восстанавливается:**
- IndexedDB в браузерах пользователей
- Данные, загруженные на ImgBB

---

## 4. Откат на Render.com

### Через Dashboard

1. Войти в [Render Dashboard](https://dashboard.render.com)
2. Выбрать сервис **Camera ZeroDay**
3. Перейти в раздел **"Events"** или **"Deploys"**
4. Найти предыдущий успешный деплой
5. Нажать **"Rollback to this deploy"**

### Через CLI (если установлен)

```bash
# Список деплоев
render deploys list --service <service-id>

# Откат к конкретному деплою
render deploys rollback --service <service-id> --deploy <deploy-id>
```

### Время отката

- Render выполняет откат за 1-3 минуты
- Новый контейнер поднимается с предыдущей версией
- Health check должен пройти успешно

---

## 5. Откат Service Worker

### Проблема

Даже после отката сервера, у пользователей может быть закэширован старый Service Worker.

### Решение 1: Обновление версии кэша

При откате обязательно изменить `CACHE_VERSION` в `sw.js`:

```javascript
// Было (проблемная версия)
const CACHE_VERSION = '1.2.0';

// Стало (откат + инкремент)
const CACHE_VERSION = '1.1.1';
```

### Решение 2: Принудительное обновление

Добавить в приложение механизм проверки версии:

```javascript
// Проверка новой версии SW
navigator.serviceWorker.ready.then((registration) => {
  registration.update();
});
```

### Очистка у пользователя (инструкция)

1. Открыть DevTools (F12)
2. Перейти в Application → Service Workers
3. Нажать **"Unregister"**
4. Очистить кэш: Application → Storage → Clear site data
5. Перезагрузить страницу

---

## 6. Откат IndexedDB

### Важно

IndexedDB хранится локально в браузере пользователя. Сервер не может откатить эти данные.

### Сценарии

| Ситуация | Действие |
|----------|----------|
| Изменилась схема БД | Миграция или очистка |
| Повреждённые данные | Экспорт → Очистка → Импорт |
| Критический баг | Инструкция пользователю |

### Инструкция для пользователя (при критическом баге)

1. Экспортировать фотографии (если возможно)
2. DevTools → Application → IndexedDB
3. Правый клик на базу → Delete database
4. Перезагрузить приложение

---

## 7. Чеклист после отката

### Немедленно

- [ ] Проверить, что приложение загружается
- [ ] Проверить консоль на ошибки
- [ ] Проверить работу камеры
- [ ] Проверить сохранение фото
- [ ] Проверить работу геолокации

### В течение 1 часа

- [ ] Проверить PWA установку
- [ ] Проверить офлайн режим
- [ ] Проверить загрузку в облако (ImgBB)
- [ ] Проверить режим приватности

### Мониторинг

- [ ] Следить за логами ошибок
- [ ] Проверить метрики производительности
- [ ] Собрать обратную связь от пользователей

---

## Контакты для эскалации

При критических проблемах:

1. **Replit Support:** support@replit.com
2. **Render Status:** status.render.com

---

*Документ обновлён: 2 декабря 2025*
